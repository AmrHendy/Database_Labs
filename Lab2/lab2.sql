CREATE SCHEMA LIBRARY;

USE LIBRARY;

CREATE TABLE `BOOK` (
  `BOOK_ID` int(11) NOT NULL,
  `TITLE` varchar(200) DEFAULT NULL,
  `PUBLISHER_NAME` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`BOOK_ID`)
);

CREATE TABLE `BOOK_AUTHORS` (
  `BOOK_ID` int(11) NOT NULL,
  `AUTHOR_NAME` varchar(200) NOT NULL,
  PRIMARY KEY (`BOOK_ID`,`AUTHOR_NAME`)
);

CREATE TABLE `BOOK_COPIES` (
  `BOOK_ID` int(11) NOT NULL,
  `BRANCH_ID` int(11) NOT NULL,
  `NO_OF_COPIES` int(11) DEFAULT NULL,
  PRIMARY KEY (`BOOK_ID`,`BRANCH_ID`)
);

CREATE TABLE `BOOK_LOANS` (
  `BOOK_ID` int(11) NOT NULL,
  `BRANCH_ID` int(11) NOT NULL,
  `CARD_NO` varchar(50) NOT NULL,
  `DATE_OUT` datetime DEFAULT NULL,
  `DUE_DATE` datetime DEFAULT NULL,
  PRIMARY KEY (`BOOK_ID`,`BRANCH_ID`,`CARD_NO`)
);

CREATE TABLE `BORROWER` (
  `CARD_NO` varchar(50) NOT NULL,
  `NAME` varchar(200) DEFAULT NULL,
  `ADDRESS` varchar(200) DEFAULT NULL,
  `PHONE` varchar(50) DEFAULT NULL,
  PRIMARY KEY (`CARD_NO`)
);

CREATE TABLE `LIBRARY_BRANCH` (
  `BRANCH_ID` int(11) NOT NULL,
  `BRANCH_NAME` varchar(200) DEFAULT NULL,
  `ADDRESS` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`BRANCH_ID`)
);

CREATE TABLE `PUBLISHER` (
  `NAME` varchar(200) NOT NULL,
  `ADDRESS` varchar(200) DEFAULT NULL,
  `PHONE` varchar(20) DEFAULT NULL,
  PRIMARY KEY (`NAME`)
);

ALTER TABLE BOOK ADD CONSTRAINT `BOOK_PUBLISHER_FK` FOREIGN KEY (`PUBLISHER_NAME`) REFERENCES `PUBLISHER` (`NAME`) ON DELETE NO ACTION ON UPDATE NO ACTION;
ALTER TABLE BOOK_AUTHORS ADD CONSTRAINT `BOOK_AUTHORS_BOOK_FK` FOREIGN KEY (`BOOK_ID`) REFERENCES `BOOK` (`BOOK_ID`) ON DELETE NO ACTION ON UPDATE NO ACTION;
ALTER TABLE BOOK_COPIES ADD CONSTRAINT `BOOK_COPIES_BOOK_FK` FOREIGN KEY (`BOOK_ID`) REFERENCES `BOOK` (`BOOK_ID`) ON DELETE NO ACTION ON UPDATE NO ACTION;
ALTER TABLE BOOK_COPIES ADD CONSTRAINT `BOOK_COPIES_BRANCH_FK` FOREIGN KEY (`BRANCH_ID`) REFERENCES `LIBRARY_BRANCH` (`BRANCH_ID`) ON DELETE NO ACTION ON UPDATE NO ACTION;
ALTER TABLE BOOK_LOANS ADD CONSTRAINT `BOOK_LOANS_BOOK_FK` FOREIGN KEY (`BOOK_ID`) REFERENCES `BOOK` (`BOOK_ID`) ON DELETE NO ACTION ON UPDATE NO ACTION;
ALTER TABLE BOOK_LOANS ADD CONSTRAINT `BOOK_LOANS_BRANCH_FK` FOREIGN KEY (`BRANCH_ID`) REFERENCES `LIBRARY_BRANCH` (`BRANCH_ID`) ON DELETE NO ACTION ON UPDATE NO ACTION;
ALTER TABLE BOOK_LOANS ADD CONSTRAINT `BOOK_LOANS_BORROWER_FK` FOREIGN KEY (`CARD_NO`) REFERENCES `BORROWER` (`CARD_NO`) ON DELETE NO ACTION ON UPDATE NO ACTION;

INSERT INTO BORROWER VALUES('S0001','Mark', 'Houston Texas','+1-503-4050501');
INSERT INTO BORROWER VALUES('S0002','Alice', 'Houston Texas','+1-503-4050502');
INSERT INTO BORROWER VALUES('S0003','Steven', 'San diego California','+1-503-4050503');
INSERT INTO BORROWER VALUES('S0004','Antonio', 'San diego California','+1-503-4050504');
INSERT INTO BORROWER VALUES('S0005','Suzan', 'Ontario Canada','+1-503-4050505');
INSERT INTO BORROWER VALUES('S0006','Peter', 'Ontario Canada','+1-503-4050506');
INSERT INTO BORROWER VALUES('S0007','Nicole', 'Washington DC','+1-503-4050507');
INSERT INTO BORROWER VALUES('S0008','Hannah', 'Washington DC','+1-503-4050508');


INSERT INTO LIBRARY_BRANCH VALUES(1,'Central','Houston Texas');
INSERT INTO LIBRARY_BRANCH VALUES(2,'Sharpstown','San diego California');
INSERT INTO LIBRARY_BRANCH VALUES(3,'Hamilton','Ontario Canada');
INSERT INTO LIBRARY_BRANCH VALUES(4,'Broadway','Washington DC');

INSERT INTO PUBLISHER VALUES('McGrawHill','USA','+1-503-5050501');
INSERT INTO PUBLISHER VALUES('Pearson','USA','+1-503-5050502');
INSERT INTO PUBLISHER VALUES('Wiley','USA','+1-503-5050503');
INSERT INTO PUBLISHER VALUES('Springer','USA','+1-503-5050504');

INSERT INTO BOOK VALUES('1','The Lost Tribe','McGrawHill');
INSERT INTO BOOK VALUES('2','Atlantis','McGrawHill');
INSERT INTO BOOK VALUES('3','Cast Away','Pearson');
INSERT INTO BOOK VALUES('4','Inferno','Wiley');
INSERT INTO BOOK VALUES('5','Perfume','Springer');
INSERT INTO BOOK VALUES('6','Tintin','Springer');


INSERT INTO BOOK_COPIES VALUES(1,1,5);
INSERT INTO BOOK_COPIES VALUES(1,2,6);
INSERT INTO BOOK_COPIES VALUES(1,3,4);
INSERT INTO BOOK_COPIES VALUES(1,4,3);
INSERT INTO BOOK_COPIES VALUES(2,1,5);
INSERT INTO BOOK_COPIES VALUES(2,2,7);
INSERT INTO BOOK_COPIES VALUES(2,3,8);
INSERT INTO BOOK_COPIES VALUES(2,4,11);
INSERT INTO BOOK_COPIES VALUES(3,1,3);
INSERT INTO BOOK_COPIES VALUES(3,2,2);
INSERT INTO BOOK_COPIES VALUES(3,3,5);
INSERT INTO BOOK_COPIES VALUES(3,4,6);
INSERT INTO BOOK_COPIES VALUES(4,1,5);
INSERT INTO BOOK_COPIES VALUES(4,2,5);
INSERT INTO BOOK_COPIES VALUES(4,3,8);
INSERT INTO BOOK_COPIES VALUES(4,4,5);
INSERT INTO BOOK_COPIES VALUES(5,1,1);
INSERT INTO BOOK_COPIES VALUES(5,2,7);
INSERT INTO BOOK_COPIES VALUES(5,3,9);
INSERT INTO BOOK_COPIES VALUES(5,4,12);
INSERT INTO BOOK_COPIES VALUES(6,1,3);
INSERT INTO BOOK_COPIES VALUES(6,2,4);
INSERT INTO BOOK_COPIES VALUES(6,3,2);
INSERT INTO BOOK_COPIES VALUES(6,4,5);

INSERT INTO BOOK_AUTHORS VALUES(1,'Stephen King');
INSERT INTO BOOK_AUTHORS VALUES(1,'Andrew');
INSERT INTO BOOK_AUTHORS VALUES(2,'Paolo Coelho');
INSERT INTO BOOK_AUTHORS VALUES(3,'Spielberg');
INSERT INTO BOOK_AUTHORS VALUES(3,'Wilson');
INSERT INTO BOOK_AUTHORS VALUES(4,'Dan Brown');
INSERT INTO BOOK_AUTHORS VALUES(5,'Dumas');
INSERT INTO BOOK_AUTHORS VALUES(5,'Dantes');
INSERT INTO BOOK_AUTHORS VALUES(6,'Milo');

INSERT INTO BOOK_LOANS VALUES(1,1,'S0001',NOW()-INTERVAL 1 DAY,NOW()+INTERVAL 7 DAY);
INSERT INTO BOOK_LOANS VALUES(2,1,'S0001',NOW()-INTERVAL 2 DAY,NOW()+INTERVAL 6 DAY);
INSERT INTO BOOK_LOANS VALUES(3,1,'S0001',NOW()-INTERVAL 3 DAY,NOW()+INTERVAL 5 DAY);
INSERT INTO BOOK_LOANS VALUES(5,1,'S0002',NOW()-INTERVAL 7 DAY,NOW());
INSERT INTO BOOK_LOANS VALUES(4,1,'S0002',NOW()-INTERVAL 7 DAY,NOW());
INSERT INTO BOOK_LOANS VALUES(1,2,'S0003',NOW()-INTERVAL 7 DAY,NOW());
INSERT INTO BOOK_LOANS VALUES(4,1,'S0004',NOW()-INTERVAL 5 DAY,NOW());
INSERT INTO BOOK_LOANS VALUES(2,2,'S0004',NOW()-INTERVAL 7 DAY,NOW());
INSERT INTO BOOK_LOANS VALUES(6,3,'S0005',NOW()-INTERVAL 1 DAY,NOW()+INTERVAL 1 DAY);
INSERT INTO BOOK_LOANS VALUES(5,4,'S0007',NOW()-INTERVAL 1 DAY,NOW()+INTERVAL 1 DAY);
INSERT INTO BOOK_LOANS VALUES(3,4,'S0008',NOW()-INTERVAL 1 DAY,NOW());




/*a*/
SELECT NO_OF_COPIES FROM BOOK_COPIES 
WHERE
BOOK_COPIES.BRANCH_ID IN (SELECT BRANCH_ID FROM LIBRARY_BRANCH WHERE BRANCH_NAME = "Sharpstown")
AND
BOOK_COPIES.BOOK_ID IN (SELECT BOOK_ID FROM BOOK WHERE TITLE = "The Lost Tribe");



/*B*/
SELECT BRANCH_ID, NO_OF_COPIES FROM BOOK_COPIES 
WHERE
BOOK_COPIES.BOOK_ID IN (SELECT BOOK_ID FROM BOOK WHERE TITLE = "The Lost Tribe");




/*c*/
SELECT BORROWER.NAME FROM BORROWER 
WHERE(
BORROWER.CARD_NO 
NOT IN( SELECT CARD_NO FROM BOOK_LOANS)
);


/*d*/
SELECT BOOK.TITLE, BORROWER.NAME, BORROWER.ADDRESS FROM 
(
BOOK_LOANS 
JOIN 
LIBRARY_BRANCH ON BOOK_LOANS.BRANCH_ID = LIBRARY_BRANCH.BRANCH_ID
JOIN
BOOK ON BOOK.BOOK_ID = BOOK_LOANS.BOOK_ID
JOIN 
BORROWER ON BORROWER.CARD_NO = BOOK_LOANS.CARD_NO
)
WHERE LIBRARY_BRANCH.BRANCH_NAME = "Sharpstown" AND BOOK_LOANS.DUE_DATE < NOW();



/*E*/
SELECT BRANCH_NAME, COUNT(*) FROM 
(LIBRARY_BRANCH JOIN BOOK_LOANS ON LIBRARY_BRANCH.BRANCH_ID = BOOK_LOANS.BRANCH_ID)
GROUP BY BRANCH_NAME;



/*F*/
SELECT BORROWER.NAME, BORROWER.ADDRESS, COUNT(*) FROM 
(BORROWER JOIN BOOK_LOANS ON BORROWER.CARD_NO = BOOK_LOANS.CARD_NO)
WHERE BOOK_LOANS.CARD_NO IN (SELECT BOOK_LOANS.CARD_NO FROM BOOK_LOANS GROUP BY BOOK_LOANS.CARD_NO HAVING COUNT(*) > 2)
GROUP BY BOOK_LOANS.CARD_NO;



/*G*/
SELECT TITLE, NO_OF_COPIES FROM 
(BOOK_AUTHORS JOIN BOOK ON BOOK.BOOK_ID = BOOK_AUTHORS.BOOK_ID 
JOIN BOOK_COPIES ON BOOK.BOOK_ID = BOOK_COPIES.BOOK_ID)
WHERE AUTHOR_NAME = "Stephen King" 
AND BRANCH_ID IN (SELECT BRANCH_ID FROM LIBRARY_BRANCH WHERE BRANCH_NAME = "Central");
